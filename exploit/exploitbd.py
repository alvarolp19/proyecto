import os
import mysql.connector
from mysql.connector import Error
import json

def obtener_ultimo_archivo_json(directorio):
    lista_archivos = [archivo for archivo in os.listdir(directorio) if archivo.endswith('.json')]
    if lista_archivos:
        return max(lista_archivos, key=lambda archivo: os.path.getctime(os.path.join(directorio, archivo)))
    else:
        return None

def conectar_mysql(host, usuario, contraseña, base_datos):
    try:
        conexion = mysql.connector.connect(
            host=host,
            user=usuario,
            password=contraseña,
            database=base_datos
        )
        if conexion.is_connected():
            print("Conexión establecida correctamente.")
            return conexion
    except Error as e:
        print(f"Error al conectarse a MySQL: {e}")
        return None

def insertar_exploits(conexion, datos):
    try:
        cursor = conexion.cursor()
        sql_insert = "INSERT INTO exploit (Fecha, Titulo, Tipo, Plataforma) VALUES (%s, %s, %s, %s)"
        for d in datos:
            val = (d['Date'], d['Title'], d['Type'], d['Platform'])
            cursor.execute(sql_insert, val)
        conexion.commit()
        print(f"Se insertaron {len(datos)} registros.")
    except Error as e:
        print(f"Error al insertar exploits: {e}")

# Cargar configuración desde config.json
with open('config.json', 'r') as config_file:
    config = json.load(config_file)

host = config['host']
usuario = config['usuario']
contraseña = config['contraseña']
base_datos = config['base_datos']

# Directorio donde se almacenan los archivos JSON (ruta relativa)
directorio_json = os.path.join(os.path.dirname(__file__), 'registros_diarios')

# Obtener el nombre del último archivo JSON en el directorio
nombre_archivo_nuevas_entradas = obtener_ultimo_archivo_json(directorio_json)

if nombre_archivo_nuevas_entradas:
    # Conexión a MySQL
    conexion = conectar_mysql(host, usuario, contraseña, base_datos)
    # Insertar datos en MySQL desde el archivo JSON
    if conexion:
        with open(os.path.join(directorio_json, nombre_archivo_nuevas_entradas), 'r') as archivo:
            nuevos_datos = json.load(archivo)
        insertar_exploits(conexion, nuevos_datos)
        conexion.close()

